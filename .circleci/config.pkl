amends ".../pkl/.circleci/PklCI.pkl"

local swiftTest = new RunStep {
  name = "swift test"
  command = """
    mkdir -p .out/test-results/
    swift test -vv --parallel --num-workers 1 --xunit-output .out/test-results/xunit.xml -Xswiftc -warnings-as-errors
    """
}

main {
  jobs {
    "test"
  }
}

prb {
  jobs {
    "test"
  }
}

release {
  jobs {
    "test"
    new {
      ["pkl-package"] {
        requires {
          "test"
        }
      }
    }
    new {
      ["pkl-gen-swift-macos"] {
        requires {
          "test"
        }
      }
    }
    new {
      ["do-release"] {
        requires {
          "pkl-package"
          "pkl-gen-swift-macos"
        }
      }
    }
  }
}

jobs {
  ["test"] {
    macos {
      xcode = "15.2.0"
    }
    resource_class = "macos.m1.large.gen1"
    // TODO(oss) remove me, and download Pkl from CI
    environment {
      ["PKL_EXEC"] = "bin/pkl-cli-macos-amd64.bin"
    }
    steps {
      "checkout"
      swiftTest
      new RunStep { command = "make test-snippets" }
      new RunStep { command = "make test-pkl" }
      new RunStep { command = "make generate-fixtures" }
      new StoreTestResults {
        path = ".out/test-results/"
      }
    }
  }

  ["pkl-gen-swift-macos"] {
    macos {
      xcode = "15.2.0"
    }
    // TODO(oss) remove me, and download Pkl from CI
    environment {
      ["PKL_EXEC"] = "bin/pkl-cli-macos-amd64.bin"
    }
    steps {
      "checkout"
      new RunStep {
        command = """
          make pkl-gen-swift-release
          mkdir -p out/pkl-gen-swift/
          cp $(make pkl-gen-swift-release-output) out/pkl-gen-swift/pkl-gen-swift-macos.bin
          """
      }
      new PersistToWorkspaceStep { paths { "out/" }; root = "." }
    }
  }

  ["pkl-package"] {
    docker {
      new { image = "cimg/base:current" }
    }
    steps {
      // TODO(oss) remove --skip-publish-check
      new RunStep {
        command = "pkl project package --skip-publish-check --output-path out/pkl-package/ codegen/src/*"
      }
      new PersistToWorkspaceStep {
        paths {
          "out/"
        }
        root = "."
      }
    }
  }

  ["do-release"] {
    docker {
      new { image = "maniator/gh:v2.40.1" }
    }
    // TODO(oss) remove me, and download Pkl from CI
    environment {
      ["PKL_EXEC"] = "bin/pkl-cli-macos-amd64.bin"
    }
    steps {
      new AttachWorkspaceStep { at = "." }
      new RunStep {
        command = #"""
          echo "Creating release for Swift library"
          gh release create ${CIRCLE_TAG} \
            --title "pkl-swift ${CIRCLE_TAG}" \
            --target "${CIRCLE_SHA1}" \
            --verify-tag \
            --notes "Release notes: https://pkl-lang.org/swift/CHANGELOG.html#release-${VERSION}" \
            --repo "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" \
            out/pkl-gen-swift/

          echo "Creating release for Pkl package"
          gh release create ${CIRCLE_TAG} \
            --title "pkl.swift@${CIRCLE_TAG}" \
            --target "${CIRCLE_SHA1}" \
            --notes "This holds the release assets for the pkl.swift package. Release notes: https://pkl-lang.org/swift/CHANGELOG.html#release-${VERSION}" \
            --repo "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" \
            out/pkl-package/
          """#
      }
    }
  }
}
