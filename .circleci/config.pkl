amends ".../pkl/.circleci/PklCI.pkl"


local swiftTest = new RunStep {
  name = "swift test"
  command = """
    mkdir -p .out/test-results/
    swift test -vv --parallel --num-workers 1 --xunit-output .out/test-results/xunit.xml -Xswiftc -warnings-as-errors
    """
}

main {
  jobs {
    "test"
  }
}

jobs {
  ["test"] {
    macos {
      xcode = "15.2.0"
    }
//     docker {
//       new { image = "swift:5.9-rhel-ubi9" }
//     }
//     resource_class = "large"
    environment {
      ["PKL_EXEC"] = "bin/pkl-cli-macos-amd64.bin"
    }
    steps {
      "checkout"
      swiftTest
      new RunStep { command = "make test-snippets" }
      new RunStep { command = "make test-pkl" }
      new RunStep { command = "make generate-fixtures" }
      new StoreTestResults {
        path = ".out/test-results/"
      }
    }
  }
}

workflows {
  ["main"] {
    `when` {
      equal {
        "main"
        "<< pipeline.git.branch >>"
      }
    }
    jobs {
      "test"
    }
  }
}