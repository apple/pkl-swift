amends "../../pkl/.circleci/CircleCI.pkl"

version = 2.1

local swiftTest = new RunStep {
  name = "swift test"
  command = """
    export PKL_DEBUG=1
    mkdir -p .out/test-results/
    swift test -vv --parallel --num-workers 1 --xunit-output .out/test-results/xunit.xml -Xswiftc -warnings-as-errors
    """
}

jobs {
  ["test"] {
    macos {
      xcode = "15.2.0"
    }
//     docker {
//       new { image = "swift:5.9-rhel-ubi9" }
//     }
//     resource_class = "large"
    environment {
      ["PKL_EXEC"] = "bin/pkl-cli-macos-amd64.bin"
      ["PKL_DEBUG"] = "1"
    }
    steps {
      "checkout"
      swiftTest
      module.run("make test-snippets")
      module.run("make test-pkl")
      module.run("make generate-fixtures")
      new StoreTestResults {
        path = ".out/test-results/"
      }
    }
  }
}

workflows {
  ["main"] {
    `when` {
      equal {
        "main"
        "<< pipeline.git.branch >>"
      }
    }
    jobs {
      "test"
    }
  }
}