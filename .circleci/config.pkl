amends "../../pkl/.circleci/CircleCI.pkl"

version = 2.1

local swiftTest = new RunStep {
  name = "swift test"
  command = """
    swift test -vv --parallel --num-workers 1 --xunit-output .out/test-results/junit.xml -Xswiftc -warnings-as-errors
    """
}

jobs {
  ["test"] {
    docker {
      new { image = "swift:5.9-rhel-ubi9" }
    }
    resource_class = "medium+"
    environment {
      ["PKL_EXEC"] = "bin/pkl-cli-amd64.bin"
      ["PKL_DBEUG"] = "1"
    }
    steps {
      "checkout"
      swiftTest
//       module.run("make test-snippets")
//       module.run("make test-pkl")
//       module.run("make generate-fixtures")
    }
  }
}

workflows {
  ["main"] {
    `when` {
      equal {
        "main"
        "<< pipeline.git.branch >>"
      }
    }
    jobs {
      "test"
    }
  }
}