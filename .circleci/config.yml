# Generated from CircleCI.pkl. DO NOT EDIT.
version: 2.1
orbs:
  pr-approval: pkl-lang/pr-approval@dev:third
jobs:
  test:
    steps:
    - checkout
    - run:
        command: |-
          mkdir -p .out/test-results/
          swift test -vv --parallel --num-workers 1 --xunit-output .out/test-results/xunit.xml -Xswiftc -warnings-as-errors
        name: swift test
    - run:
        command: make test-snippets
    - run:
        command: make test-pkl
    - run:
        command: make generate-fixtures
    - store_test_results:
        path: .out/test-results/
    environment:
      PKL_EXEC: bin/pkl-cli-macos-amd64.bin
    resource_class: xlarge
    docker:
    - image: swift:5.9-rhel-ubi9
  pkl-gen-swift-macos:
    steps:
    - checkout
    - run:
        command: |-
          make pkl-gen-swift-release
          mkdir -p out/pkl-gen-swift/
          cp $(make pkl-gen-swift-release-output) out/pkl-gen-swift/pkl-gen-swift-macos.bin
    - persist_to_workspace:
        root: '.'
        paths:
        - out/
    environment:
      PKL_EXEC: bin/pkl-cli-amd64.bin
    macos:
      xcode: 15.2.0
  pkl-package:
    steps:
    - run:
        command: pkl project package --skip-publish-check --output-path out/pkl-package/ codegen/src/*
    - persist_to_workspace:
        root: '.'
        paths:
        - out/
    docker:
    - image: cimg/base:current
  do-release:
    steps:
    - attach_workspace:
        at: '.'
    - run:
        command: |-
          echo "Creating release for Swift library"
          gh release create ${CIRCLE_TAG} \
            --title "pkl-swift ${CIRCLE_TAG}" \
            --target "${CIRCLE_SHA1}" \
            --verify-tag \
            --notes "Release notes: https://pkl-lang.org/swift/CHANGELOG.html#release-${VERSION}" \
            --repo "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" \
            out/pkl-gen-swift/

          echo "Creating release for Pkl package"
          gh release create ${CIRCLE_TAG} \
            --title "pkl.swift@${CIRCLE_TAG}" \
            --target "${CIRCLE_SHA1}" \
            --notes "This holds the release assets for the pkl.swift package. Release notes: https://pkl-lang.org/swift/CHANGELOG.html#release-${VERSION}" \
            --repo "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" \
            out/pkl-package/
    environment:
      PKL_EXEC: bin/pkl-cli-macos-amd64.bin
    docker:
    - image: maniator/gh:v2.40.1
workflows:
  prb:
    jobs:
    - test
    when:
      matches:
        value: << pipeline.git.branch >>
        pattern: ^pull/\d+(/head)?$
  main:
    jobs:
    - test
    when:
      equal:
      - main
      - << pipeline.git.branch >>
  release:
    jobs:
    - test:
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v?\d+\.\d+\.\d+$/
    - pkl-package:
        requires:
        - test
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v?\d+\.\d+\.\d+$/
    - pkl-gen-swift-macos:
        requires:
        - test
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v?\d+\.\d+\.\d+$/
    - do-release:
        requires:
        - pkl-package
        - pkl-gen-swift-macos
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v?\d+\.\d+\.\d+$/
